name: Arch Linux Daily Dependency Check

on:
  # Run daily at 00:00 UTC
  schedule:
    - cron: '0 0 * * *'
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild even if dependencies unchanged'
        required: false
        default: 'false'

jobs:
  check-and-rebuild:
    runs-on: ubuntu-22.04
    outputs:
      should_build: ${{ steps.should_build.outputs.needed }}
      pkgrel: ${{ steps.version.outputs.pkgrel }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Check if AUR package works with current dependencies
      id: check_deps
      run: |
        chmod +x tools/ci/check-archlinux-deps.sh
        if tools/ci/check-archlinux-deps.sh || [ "${{ github.event.inputs.force_rebuild }}" = "true" ]; then
          echo "broken=true" >> $GITHUB_OUTPUT
        else
          echo "broken=false" >> $GITHUB_OUTPUT
        fi

    - name: Check for new commits since last AUR package
      id: check_commits
      if: steps.check_deps.outputs.broken == 'false'
      run: |
        # Get current commit info
        CURRENT_COMMIT=$(git rev-parse HEAD)
        CURRENT_COUNT=$(git rev-list --count HEAD)

        echo "Current commit: $CURRENT_COMMIT (commit count: $CURRENT_COUNT)"

        # Clone AUR package to check what's published
        TEMP_DIR=$(mktemp -d)
        cd "$TEMP_DIR"

        # Try to fetch from AUR (may fail if package doesn't exist yet)
        if git clone https://aur.archlinux.org/arma3-unix-launcher-bin.git aur-pkg 2>/dev/null; then
          cd aur-pkg
          # Extract pkgver from PKGBUILD (format: 420.5b3bf5e)
          AUR_VERSION=$(grep "^pkgver=" PKGBUILD | cut -d'=' -f2)
          AUR_COMMIT_COUNT=$(echo "$AUR_VERSION" | cut -d'.' -f1)
          AUR_COMMIT_HASH=$(echo "$AUR_VERSION" | cut -d'.' -f2)

          echo "AUR package version: $AUR_VERSION (commit count: $AUR_COMMIT_COUNT)"

          # Validate that AUR_COMMIT_COUNT is a positive integer
          if [[ "$AUR_COMMIT_COUNT" =~ ^[0-9]+$ ]]; then
            if [ "$CURRENT_COUNT" -gt "$AUR_COMMIT_COUNT" ]; then
              echo "✓ New commits detected! Current: $CURRENT_COUNT, AUR: $AUR_COMMIT_COUNT"
              echo "has_new_commits=true" >> $GITHUB_OUTPUT
            else
              echo "No new commits (Current: $CURRENT_COUNT, AUR: $AUR_COMMIT_COUNT)"
              echo "has_new_commits=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "⚠ Invalid version format in AUR package, assuming rebuild needed"
            echo "has_new_commits=true" >> $GITHUB_OUTPUT
          fi
        else
          echo "⚠ AUR package not found or inaccessible, assuming rebuild needed"
          echo "has_new_commits=true" >> $GITHUB_OUTPUT
        fi

        cd "${{ github.workspace }}"
        rm -rf "$TEMP_DIR"

    - name: Determine if build is needed
      id: should_build
      run: |
        DEPS_BROKEN="${{ steps.check_deps.outputs.broken }}"
        NEW_COMMITS="${{ steps.check_commits.outputs.has_new_commits }}"

        if [ "$DEPS_BROKEN" = "true" ]; then
          echo "✓ Build needed: AUR package broken with current Arch dependencies"
          echo "needed=true" >> $GITHUB_OUTPUT
        elif [ "$NEW_COMMITS" = "true" ]; then
          echo "✓ Build needed: New commits since last AUR package"
          echo "needed=true" >> $GITHUB_OUTPUT
        else
          echo "✗ Build not needed: No changes detected"
          echo "needed=false" >> $GITHUB_OUTPUT
        fi

    - name: Download previous package for version comparison
      if: steps.should_build.outputs.needed == 'true'
      continue-on-error: true
      uses: dawidd6/action-download-artifact@v6
      with:
        workflow: archlinux_daily_check.yml
        name: archlinux-package
        path: /tmp/previous-package

    - name: Determine pkgrel version
      if: steps.should_build.outputs.needed == 'true'
      id: version
      run: |
        chmod +x tools/ci/bump-pkgrel.sh
        PREVIOUS_PKG=""
        if [ -f /tmp/previous-package/*.pkg.tar.zst ]; then
          PREVIOUS_PKG=$(ls /tmp/previous-package/*.pkg.tar.zst | head -1)
        fi
        PKGREL=$(tools/ci/bump-pkgrel.sh ${{ github.workspace }} "$PREVIOUS_PKG")
        echo "pkgrel=$PKGREL" >> $GITHUB_OUTPUT
        echo "Determined pkgrel: $PKGREL"

  build-and-publish:
    needs: check-and-rebuild
    if: needs.check-and-rebuild.outputs.should_build == 'true'
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set permissions
      run: chmod 755 ${{ github.workspace }}

    - name: Pull Docker image from Docker Hub
      run: |
        echo "=== Pulling Docker image from Docker Hub ==="
        docker pull muttleyxd/a3ul_archlinux_build:latest
        docker tag muttleyxd/a3ul_archlinux_build:latest a3ul_archlinux_build:latest

    - name: Build package
      run: |
        DOCKER_IMAGE="a3ul_archlinux_build:latest"
        tools/ci/build-archlinux-in-docker.sh \
          ${{ github.workspace }} \
          ${{ needs.check-and-rebuild.outputs.pkgrel }} \
          "$DOCKER_IMAGE"

    - name: Upload package as artifact
      uses: actions/upload-artifact@v4
      with:
        name: archlinux-package
        path: "*.pkg.tar.*"
        retention-days: 90

    - name: Create draft release
      uses: xresloader/upload-to-github-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.actionrelease }}
      with:
        file: "*.pkg.tar.*"
        draft: true

    - name: Setup SSH for AUR
      if: success()
      env:
        AUR_SSH_PRIVATE_KEY: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
      run: |
        tools/ci/setup-aur-ssh.sh "${{ github.workspace }}/.ssh-aur"

    - name: Publish to AUR
      if: success()
      run: |
        DOCKER_IMAGE="a3ul_archlinux_build:latest"
        tools/ci/publish-to-aur-in-docker.sh \
          ${{ github.workspace }} \
          ${{ needs.check-and-rebuild.outputs.pkgrel }} \
          ${{ github.workspace }}/.ssh-aur \
          "$DOCKER_IMAGE"
